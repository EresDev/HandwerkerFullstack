dist: Xenial
language:
  - php
sudo: required #TODO: remove all sudos
php:
  - 7.4
addons:
  chrome: stable
  apt:
    packages:
      - nginx
      - realpath
  hosts:
    - hwfs.local
#cache:
#  yarn: true
#  directories:
#    - vendor
#    - "$HOME/.composer/cache/files"
#    - node_modules
env:
  global:
    - SYMFONY_VERSION="4.3.*" DB=mysql
    - SITE_URL="http://hwfs.local"
    - SITE_DOMAIN="hwfs.local"

before_install:
  #update Nodejs
  - nvm install --lts
  - nvm use --lts
  - npm --version

  - google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost &
  - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.22.4
  - export PATH="$HOME/.yarn/bin:$PATH"

services:
  - mysql
install:
  - ls
  - cp .env.travis .env
  - chmod +x travis/install-nginx.sh
  #TODO: generate SSL certificate files, do not use existing ones
  - travis/install-nginx.sh
  - composer install
  - yarn install
  - yarn encore dev
  #- yarn encore dev-server --port 8080
  - php bin/console doctrine:database:create --env=test
  - php bin/console doctrine:schema:create --env=test
  - mkdir -p config/jwt
  - openssl genpkey -out config/jwt/private.pem -aes256 -algorithm rsa -pkeyopt rsa_keygen_bits:4096 -pass pass:7834rhgi8uhgfuw834hr879329hr
  - openssl pkey -in config/jwt/private.pem -out config/jwt/public.pem -pubout -passin pass:7834rhgi8uhgfuw834hr879329hr
  - cd public
  - ls -l
script:
  #- curl -k 'https://hwfs.local/public/build/app.js'
  #- cat webpack.config.js
  - php bin/phpunit #tests/End2End/Infrastructure/Controller/RegisterUserControllerFrontendTest.php --debug